<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç–«è‹—é ç´„</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#f6fbff;
      --card:#ffffff;
      --main:#34b7a7;
      --main2:#2aa295;
      --text:#1f2937;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
      background:linear-gradient(180deg,var(--bg),#ffffff);
      color:var(--text);
      padding:18px;
    }
    .wrap{ max-width:520px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 10px 25px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .header{
      padding:18px 18px 14px;
      background:linear-gradient(135deg,#2c7be5, var(--main));
      color:#fff;
    }
    .header h1{ margin:0; font-size:18px; }
    .header p{ margin:6px 0 0; opacity:.9; font-size:12px; }
    .content{ padding:18px; }
    .badge{
      display:inline-block;
      background:rgba(255,255,255,.2);
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      margin-top:10px;
    }
    .rules{
      margin:0;
      padding-left:18px;
      color:var(--muted);
      font-size:13px;
      line-height:1.6;
    }
    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }
    label{ display:block; margin:12px 0 6px; font-size:13px; color:#374151; }
    input,select{
      width:100%;
      box-sizing:border-box;
      padding:11px 12px;
      border:1px solid var(--border);
      border-radius:12px;
      font-size:15px;
      outline:none;
      background:#fff;
    }
    input:focus,select:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(59,130,246,.15); }
    .btn{
      width:100%;
      padding:12px 14px;
      border:none;
      border-radius:12px;
      background:var(--main);
      color:#fff;
      font-weight:700;
      font-size:15px;
      cursor:pointer;
      margin-top:16px;
    }
    .btn:hover{ background:var(--main2); }
    .hint{ margin-top:10px; font-size:12px; color:var(--muted); }
    .mini{
      margin-top:10px;
      font-size:12px;
      color:var(--muted);
      background:#f9fafb;
      border:1px dashed var(--border);
      padding:10px 12px;
      border-radius:12px;
      word-break:break-all;
    }
    .okdot{ display:inline-block; width:8px; height:8px; border-radius:99px; background:#22c55e; margin-right:6px; }
    .baddot{ display:inline-block; width:8px; height:8px; border-radius:99px; background:#ef4444; margin-right:6px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>ğŸ’‰ ç–«è‹—é ç´„ç³»çµ±</h1>
        <p>è«‹å…ˆåŒæ„è²æ˜ï¼Œå†å¡«å¯«è³‡æ–™é€å‡º</p>
        <div class="badge" id="statusBadge"><span class="baddot"></span>åˆå§‹åŒ–ä¸­â€¦</div>
      </div>

      <div class="content">
        <!-- Page 1: Rules -->
        <div id="pageRules">
          <ul class="rules">
            <li>æ¯æ™‚æ®µé™é¡ï¼ˆç”±ç³»çµ±åˆ¤æ–·ï¼‰</li>
            <li>åŒä¸€å€‹ LINE å¸³è™Ÿåƒ…èƒ½é ç´„ä¸€æ¬¡</li>
            <li>è«‹å‹™å¿…å¡«å¯«æ­£ç¢ºè³‡æ–™</li>
          </ul>

          <label style="margin-top:14px;">
            <input type="checkbox" id="agree" style="width:auto; transform:scale(1.1); margin-right:8px;">
            æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°è¦å‰‡
          </label>

          <button class="btn" id="btnNext">åŒæ„ä¸¦ç¹¼çºŒ</button>

          <div class="hint">
            è‹¥ä½ ç”¨ä¸€èˆ¬ç€è¦½å™¨é–‹å•Ÿï¼Œæœƒé¡¯ç¤ºæç¤ºï¼›æ­£å¼ä½¿ç”¨è«‹å¾ LINE å…§çš„ LIFF å…¥å£é–‹å•Ÿã€‚
          </div>
        </div>

        <!-- Page 2: Form -->
        <div id="pageForm" style="display:none;">
          <form id="form">
            <label>ç–«è‹—é …ç›®</label>
            <input name="vaccine" placeholder="ä¾‹å¦‚ï¼šæµæ„Ÿ / HPV / è‚ºç‚éˆçƒèŒ" required>

            <div class="row">
              <div>
                <label>é ç´„æ—¥æœŸ</label>
                <input type="date" name="date" required>
              </div>
              <div>
                <label>é ç´„æ™‚æ®µ</label>
                <select name="time" required>
                  <option value="">è«‹é¸æ“‡</option>
                  <option>09:00â€“09:30</option>
                  <option>09:30â€“10:00</option>
                  <option>10:00â€“10:30</option>
                  <option>15:30â€“16:00</option>
                  <option>16:30â€“17:00</option>
                  <option>19:30â€“20:00</option>
                  <option>20:00â€“20:30</option>
                </select>
              </div>
            </div>

            <label>å§“å</label>
            <input name="name" placeholder="è«‹è¼¸å…¥å§“å" required>

            <label>é›»è©±</label>
            <input name="phone" placeholder="09xx-xxx-xxx" required>

            <label>èº«åˆ†è­‰</label>
            <input name="idCard" placeholder="A123456789" required>

            <label>å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="date" name="birthday" required>

            <button class="btn" type="submit">é€å‡ºé ç´„</button>

            <div class="mini" id="debugBox" style="display:none;"></div>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
  // =========================
  // âœ… åªæ”¹é€™å…©å€‹
  // =========================
  const LIFF_ID = "2008829528-z2IIrBwj"; // ä½ å‰›å»ºç«‹çš„æ–° LIFF ID
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxtA1h2KPLTuhAc6eQX4WD7g0RHwL-YYy669ZxLlYfUBdqdovmxb4S4IMsKViWzeCw/exec"; // æ›æˆä½ çš„ /exec
  // =========================

  let lineUid = "";

  const statusBadge = document.getElementById("statusBadge");
  const pageRules = document.getElementById("pageRules");
  const pageForm  = document.getElementById("pageForm");
  const btnNext   = document.getElementById("btnNext");
  const debugBox  = document.getElementById("debugBox");

  function setStatus(ok, text){
    statusBadge.innerHTML = (ok ? '<span class="okdot"></span>' : '<span class="baddot"></span>') + text;
  }

async function initLIFF(){
  try{
    await liff.init({ liffId: "2008829528-z2IIrBwj" });

    if (!liff.isInClient()){
      setStatus(false, "è«‹å¾ LIFF å…¥å£é–‹å•Ÿ");
      Swal.fire(
        "è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ",
        "è«‹é»é¸å®˜æ–¹å¸³è™Ÿçš„åœ–æ–‡é¸å–® / LIFF é€£çµé€²å…¥ã€‚",
        "warning"
      );
      return;
    }

    if (!liff.isLoggedIn()){
      liff.login();
      return;
    }

    const profile = await liff.getProfile();
    lineUid = profile.userId;
    setStatus(true, "å·²é€£ç·š LINEï¼ˆå¯é€å‡ºï¼‰");

  }catch(err){
    setStatus(false, "LIFF åˆå§‹åŒ–å¤±æ•—");
    Swal.fire("LIFF åˆå§‹åŒ–å¤±æ•—", String(err.message || err), "error");
  }
}


  window.addEventListener("load", initLIFF);

  btnNext.addEventListener("click", () => {
    if (!document.getElementById("agree").checked){
      Swal.fire("è«‹å…ˆå‹¾é¸åŒæ„", "", "info");
      return;
    }
    pageRules.style.display = "none";
    pageForm.style.display = "block";
  });

  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!liff.isInClient() || !lineUid){
      Swal.fire("è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ", "ç›®å‰ç„¡æ³•å–å¾— LINE IDã€‚", "warning");
      return;
    }

    const data = {};
    new FormData(e.target).forEach((v,k)=> data[k]=v);
    data.lineId = lineUid; // å¾Œç«¯ç”¨ lineIdï¼ˆä½  gs ç‰ˆæœ¬æ˜¯é€™å€‹æ¬„ä½åï¼‰

    try{
      Swal.fire({ title:"é€å‡ºä¸­â€¦", allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

      const res = await fetch(GAS_EXEC_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      const json = await res.json().catch(()=>null);

      if (!res.ok || !json){
        throw new Error("å¾Œç«¯æ²’æœ‰å›å‚³ JSONï¼ˆè«‹ç¢ºèª GAS /exec èˆ‡æ¬Šé™è¨­å®šï¼‰");
      }

      if (json.ok){
        await Swal.fire("é ç´„æˆåŠŸ", "å·²å®Œæˆç™»è¨˜", "success");
        liff.closeWindow();
      } else {
        Swal.fire("é€å‡ºå¤±æ•—", json.msg || json.message || "æœªçŸ¥éŒ¯èª¤", "error");
      }
    }catch(err){
      debugBox.style.display = "block";
      debugBox.textContent = "Debug:\n" + String(err?.message || err) + "\n\nGAS:\n" + GAS_EXEC_URL;
      Swal.fire("é€å‡ºå¤±æ•—", String(err?.message || err), "error");
    }
  });
</script>
</body>
</html>

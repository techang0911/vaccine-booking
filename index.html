<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¾·æ˜Œå°å…’ç§‘è¨ºæ‰€ï½œè‡ªè²»ç–«è‹—é ç´„ç³»çµ±</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --bg:#f6fbff; --card:#fff; --ink:#1b2430; --muted:#5b6472;
      --brand:#2d7cff; --brand2:#41c7b1; --line:#e7eef7;
      --shadow:0 10px 30px rgba(23,61,127,.10); --radius:18px;
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(65,199,177,.18), transparent 55%),
        radial-gradient(900px 500px at 85% 10%, rgba(45,124,255,.16), transparent 55%),
        var(--bg);
      color:var(--ink);
      font-size:17px;
    }
    .wrap{max-width:820px;margin:0 auto}
    .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-size:22px;flex:0 0 auto;
    }
    h1{margin:0;font-size:22px;line-height:1.25}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:15px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background:rgba(45,124,255,.08);
      border:1px solid rgba(45,124,255,.18);
      color:#2051a8;font-size:13px;
    }
    .status{margin-top:10px;font-size:15px;color:#0b8;white-space:pre-wrap}
    .status.bad{color:#c00}
    .divider{height:1px;background:var(--line);margin:16px 0}
    .hint{color:var(--muted);font-size:15px;line-height:1.6;white-space:pre-wrap}
    a{color:var(--brand);text-decoration:none}
    a:hover{text-decoration:underline}

    .page{display:none}
    .page.active{display:block}

    .rules{display:grid;gap:10px;margin-top:12px}
    .rule{border:1px solid var(--line);background:#fbfdff;border-radius:14px;padding:12px;display:flex;gap:10px}
    .rule .n{
      width:26px;height:26px;border-radius:9px;
      background:rgba(65,199,177,.16);
      border:1px solid rgba(65,199,177,.28);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;color:#0c7f70;font-size:13px;flex:0 0 auto;
    }
    .rule .t{font-size:16px;line-height:1.7}

    .checkRow{
      margin-top:14px;
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(45,124,255,.35);
      background:rgba(45,124,255,.06);
    }
    .checkRow input{flex:0 0 auto;width:22px;height:22px;margin-top:2px}
    .checkRow label{
      flex:1 1 auto; min-width:0; width:100%;
      display:block; white-space:normal; word-break:break-word;
      writing-mode:horizontal-tb;
      font-size:15.5px; line-height:1.6; color:#244;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:14px;padding:12px 14px;font-size:16px;cursor:pointer}
    .btnPrimary{background:var(--brand);color:#fff}
    .btnPrimary:disabled{opacity:.55;cursor:not-allowed}
    .btnGhost{background:#eef5ff;color:#1f57b6}
    .btnDanger{background:#ffecee;color:#b30000}

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:680px){.grid2{grid-template-columns:1fr}}
    .form-group{margin-top:12px}
    label{display:block;font-size:15px;color:#324254;margin-bottom:6px}
    input,select{
      width:100%; padding:12px; background:#fff;
      border:1px solid #d8e3f2; border-radius:14px;
      font-size:16px; outline:none;
    }
    input:focus,select:focus{border-color:rgba(45,124,255,.55);box-shadow:0 0 0 4px rgba(45,124,255,.12)}
    .req{color:#c00}
    .box{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--line);background:#fbfdff}
    .box b{display:block;margin-bottom:6px}
    .small{font-size:15px;color:var(--muted);margin-top:6px}

    .times .group{margin-top:12px}
    .times .group-title{font-size:15px;color:#2b3a4c;font-weight:900;margin-bottom:8px}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid #d8e3f2;background:#fff;border-radius:999px;
      padding:9px 12px;font-size:15px;cursor:pointer;
      white-space:nowrap;
    }
    .chip.active{border-color:rgba(45,124,255,.70);box-shadow:0 0 0 4px rgba(45,124,255,.12)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">ğŸ§¸</div>
      <div>
        <h1>å¾·æ˜Œå°å…’ç§‘è¨ºæ‰€ï½œè‡ªè²»ç–«è‹—é ç´„ç³»çµ±</h1>
        <div class="subtitle">æº«é¦¨æé†’ï¼šæ‰€æœ‰ç–«è‹—æ–½æ‰“çš†éœ€å…ˆç”±é†«å¸«è©•ä¼°</div>
      </div>
    </div>

    <div class="card">
      <div class="pill">ğŸ”” é ç´„æ—¥å‰ä¸€å¤©æ™šä¸Š 19:00 æœƒæ¨æ’­é ç´„ç¢ºèª</div>
      <div id="status" class="status"></div>

      <!-- Page 1 -->
      <section id="pageRules" class="page active">
        <div class="divider"></div>
        <div class="hint"><b>é ç´„è¦å‰‡èªªæ˜ï¼ˆè«‹å…ˆè©³é–±ï¼‰</b></div>

        <div class="rules">
          <div class="rule"><div class="n">1</div><div class="t">æ¯å€‹ LINE å¸³è™Ÿåƒ…é™é ç´„ä¸€å€‹æ™‚æ®µï¼Œæ•ä¸æ¥å—é‡è¤‡æˆ–å¤šç­†é ç´„ã€‚</div></div>
          <div class="rule"><div class="n">2</div><div class="t">æ‰€æœ‰ç–«è‹—æ–½æ‰“å‰çš†é ˆç¶“é†«å¸«å•è¨ºèˆ‡è©•ä¼°ï¼Œæ˜¯å¦æ–½æ‰“ç–«è‹—å°‡ç”±é†«å¸«ä¾å°ˆæ¥­åˆ¤æ–·æ±ºå®šã€‚</div></div>
          <div class="rule"><div class="n">3</div><div class="t">æ¥ç¨®ç–«è‹—æ™‚è«‹å‹™å¿…æ”œå¸¶å¥ä¿å¡èˆ‡ç¾é‡‘ï¼Œåœ‹å°ä»¥ä¸‹å­©ç«¥å¦éœ€æ”œå¸¶å…’ç«¥å¥åº·æ‰‹å†Šï¼›æœªå‚™é½Šç›¸é—œç‰©å“è€…ï¼Œå¯èƒ½ç„¡æ³•å®Œæˆæ¥ç¨®ã€‚</div></div>
          <div class="rule"><div class="n">4</div><div class="t">è«‹ä¾é ç´„æ™‚é–“æº–æ™‚å ±åˆ°ï¼›é€¾æ™‚è€…éœ€é…åˆç¾å ´å®‰æ’ï¼Œä¸”ä¸ä¿è­‰å¯ç«‹å³æ¥ç¨®ï¼Œæ•¬è«‹ææ—©åˆ°å ´ã€‚æœ¬é ç´„æœå‹™ç„¡æ³•æŒ‡å®šé†«å¸«ï¼Œé ˆç¶“ç”±ç¾å ´äººå“¡å®‰æ’ã€‚</div></div>
          <div class="rule"><div class="n">5</div><div class="t">æœ¬é ç´„æœå‹™åƒ…æä¾›è‡ªè²»ç–«è‹—æ–½æ‰“ï¼›å¦‚éœ€çœ‹è¨ºã€æ‹¿è—¥æˆ–æœ‰åŒè¡Œè€…éœ€çœ‹è¨ºï¼Œè«‹ä¾ç¾å ´æµç¨‹å¦è¡Œæ’éšŠç­‰å€™ï¼Œé ç´„ä¸ç­‰åŒæ–¼çœ‹è¨ºæ›è™Ÿã€‚</div></div>
          <div class="rule"><div class="n">6</div><div class="t">å¦‚ç´¯è¨ˆä¸‰æ¬¡ï¼ˆå«ï¼‰ä»¥ä¸Šé ç´„æœªåˆ°ä¸”æœªäº‹å…ˆå–æ¶ˆï¼Œå°‡åœæ­¢ä½¿ç”¨æœ¬é ç´„ç³»çµ±ä¹‹æ¬Šåˆ©ã€‚</div></div>
          <div class="rule"><div class="n">7</div><div class="t">å¦‚æœ‰èº«é«”ç‹€æ³ä¸é©ã€æœªæ”œå¸¶å¿…è¦æ–‡ä»¶ã€è¶…éé ç´„æ™‚æ®µæˆ–å…¶ä»–ä¸é©åˆæ–½æ‰“ä¹‹æƒ…å½¢ï¼Œæœ¬è¨ºæ‰€æœ‰æ¬ŠåŸºæ–¼é†«ç™‚å®‰å…¨è€ƒé‡æ‹’çµ•æ–½æ‰“ç–«è‹—ã€‚</div></div>
          <div class="rule"><div class="n">8</div><div class="t">è‹¥ç„¡æ³•ä¾é ç´„æ™‚é–“å‰ä¾†ï¼Œè«‹æ–¼é ç´„æ™‚é–“å‰é€éç³»çµ±å–æ¶ˆé ç´„ï¼Œä»¥å…å½±éŸ¿å¾ŒçºŒé ç´„æ¬Šç›Šã€‚</div></div>
          <div class="rule"><div class="n">9</div><div class="t">ç–«è‹—åƒ¹æ ¼ã€æ–½æ‰“åŠ‘æ¬¡åŠç›¸é—œäº‹é …ï¼Œä¾ç¾å ´å…¬å‘ŠåŠé†«å¸«èªªæ˜ç‚ºæº–ï¼Œå¯¦éš›æ¥ç¨®å…§å®¹å°‡ä¾å€‹äººå¥åº·ç‹€æ³èª¿æ•´ã€‚</div></div>
          <div class="rule"><div class="n">10</div><div class="t">æœ¬è¨ºæ‰€ä¿ç•™é ç´„è¦å‰‡åŠç›¸é—œäº‹é …ä¹‹æœ€çµ‚è§£é‡‹èˆ‡èª¿æ•´æ¬Šåˆ©ã€‚</div></div>
        </div>

        <div class="checkRow">
          <input id="agree" type="checkbox" />
          <label for="agree">
            æˆ‘åŒæ„é ç´„è¦å‰‡åŠå€‹äººè³‡æ–™ä½¿ç”¨è²æ˜ï¼ˆ
            <a href="https://docs.google.com/document/d/1GETM2VIUddsLS0bgIMC_yXuMDY6N4-qaQlgZI_CTbRo/edit?usp=drive_link" target="_blank" rel="noopener">
              é»æˆ‘æŸ¥çœ‹å€‹äººè³‡æ–™æ”¶é›†èˆ‡ä½¿ç”¨è²æ˜
            </a>
            ï¼‰
          </label>
        </div>

        <div class="btnRow">
          <button id="btnGoBooking" class="btnPrimary" disabled type="button">é–‹å§‹é ç´„</button>
          <button id="btnHelp" class="btnGhost" type="button">æˆ‘é‡åˆ°å•é¡Œ</button>
        </div>

        <div class="hint" style="margin-top:10px;">
          å°æé†’ï¼šè«‹å‹™å¿…å¾ LINE å®˜æ–¹å…¥å£ï¼ˆåœ–æ–‡é¸å–® / LIFF é€£çµï¼‰é–‹å•Ÿï¼Œæ‰èƒ½å®Œæˆé ç´„èˆ‡é€šçŸ¥ã€‚
        </div>
      </section>

      <!-- Page 2 -->
      <section id="pageBooking" class="page">
        <div class="divider"></div>

        <form id="form">
          <div class="box">
            <b>ğŸˆ è²¼å¿ƒæé†’</b>
            <div class="hint">æ‰€æœ‰ç–«è‹—æ–½æ‰“çš†éœ€å…ˆç”±é†«å¸«è©•ä¼°ã€‚è«‹æ”œå¸¶å¥ä¿å¡ï¼Œä¸¦æº–å‚™ç¾é‡‘ã€‚åœ‹å°ä»¥ä¸‹å­©ç«¥è«‹æ”œå¸¶å…’ç«¥å¥åº·æ‰‹å†Šã€‚</div>
          </div>

          <div class="grid2">
            <div class="form-group">
              <label for="name">å§“å <span class="req">*</span></label>
              <input id="name" type="text" required autocomplete="name" />
            </div>
            <div class="form-group">
              <label for="phone">é›»è©± <span class="req">*</span></label>
              <input id="phone" type="tel" required placeholder="ä¾‹å¦‚ï¼š0912345678" />
            </div>
          </div>

          <div class="grid2">
            <div class="form-group">
              <label for="birthday">å‡ºç”Ÿå¹´æœˆæ—¥ <span class="req">*</span></label>
              <input id="birthday" type="date" required />
            </div>
            <div class="form-group">
              <label for="idCard">èº«åˆ†è­‰å­—è™Ÿ <span class="req">*</span></label>
              <input id="idCard" type="text" required />
              <div class="small">ï¼ˆä¸é™åˆ¶æ ¼å¼ï¼Œè«‹æ­£ç¢ºå¡«å¯«å³å¯ï¼‰</div>
            </div>
          </div>

          <div class="form-group">
            <label for="vaccineId">é ç´„ç–«è‹— <span class="req">*</span></label>
            <select id="vaccineId" required>
              <option value="">è¼‰å…¥ä¸­â€¦</option>
            </select>
          </div>

          <div id="vaccineInfo" class="box" style="display:none;">
            <b>ğŸ’‰ ç–«è‹—è³‡è¨Š</b>
            <div id="vaccineInfoText" class="hint"></div>
          </div>

          <div class="form-group">
            <label for="date">é ç´„æ—¥æœŸ <span class="req">*</span></label>
            <input id="date" type="date" required />
            <div class="small">å¯é ç´„ç¯„åœï¼šæœªä¾†ç¬¬ 7 å¤© ï½ ç¬¬ 28 å¤©ï¼ˆå«ï¼‰</div>
            <div class="small">å›ºå®šè¦å‰‡ï¼šé€±äº”å…¨æ—¥ä¸é–‹æ”¾ï¼›é€±æ—¥æ™šä¸Šä¸é–‹æ”¾</div>
          </div>

          <div class="form-group">
            <label>é ç´„æ™‚æ®µ <span class="req">*</span></label>
            <div id="timeGroups" class="times"></div>
            <select id="time" required style="display:none;"></select>
            <div class="small">è«‹å…ˆé¸æ—¥æœŸï¼Œå†é»é¸æ™‚æ®µã€‚</div>
          </div>

          <div class="btnRow">
            <button id="btnSubmit" class="btnPrimary" type="submit">é€å‡ºé ç´„</button>
            <button id="btnMy" class="btnGhost" type="button">æŸ¥çœ‹æˆ‘çš„é ç´„</button>
            <button id="btnCancel" class="btnDanger" type="button" style="display:none;">å–æ¶ˆæˆ‘çš„é ç´„</button>
          </div>
        </form>

        <div id="myBox" class="box" style="display:none;">
          <b>ğŸ“Œ æˆ‘çš„é ç´„</b>
          <div id="myText" class="hint"></div>
        </div>
      </section>

    </div>
  </div>

<script>
/** âœ… ä½ åªè¦æ”¹é€™å…©å€‹ */
const LIFF_ID = "2008829528-z2IIrBwj";
const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxtA1h2KPLTuhAc6eQX4WD7g0RHwL-YYy669ZxLlYfUBdqdovmxb4S4IMsKViWzeCw/exec";

let lineUid = "";
let vaccines = [];

function setStatus(ok, msg){
  const el = document.getElementById("status");
  el.className = "status" + (ok ? "" : " bad");
  el.textContent = msg || "";
}

function fmtMoney(n){ const num = Number(n||0); return num ? num.toLocaleString("zh-TW") : "0"; }
function ymd(d){
  const yy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0");
  return `${yy}-${mm}-${dd}`;
}
function dateAddDays(base, days){
  const d = new Date(base.getFullYear(), base.getMonth(), base.getDate());
  d.setDate(d.getDate()+days); return d;
}
function mdFromYmd(ymdStr){
  if (!ymdStr) return "";
  const m = String(ymdStr).match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if (m) return `${m[2]}/${m[3]}`;
  return String(ymdStr);
}
function slotHm(slot){
  if (!slot) return "";
  const s = String(slot).trim().replace(/â€“/g,"-").replace(/â€”/g,"-").replace(/\s+/g,"");
  const m = s.match(/^(\d{1,2}):(\d{2})-(\d{1,2}):(\d{2})$/);
  if (!m) return String(slot);
  return `${Number(m[1])}:${m[2]}-${Number(m[3])}:${m[4]}`;
}

/** âœ… å‰ç«¯æ—¥æœŸé™åˆ¶ï¼šæœªä¾† 7ï½28 å¤©ï¼ˆå«ï¼‰ */
function enforceDateWindow(){
  const today = new Date();
  const minD = dateAddDays(today, 7);
  const maxD = dateAddDays(today, 28);
  const dateEl = document.getElementById("date");
  dateEl.min = ymd(minD);
  dateEl.max = ymd(maxD);
}

function showPage(id){
  document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

async function initLIFF(){
  if (!LIFF_ID || LIFF_ID.includes("è«‹å¡«å…¥")) {
    setStatus(false, "è«‹å…ˆåœ¨ index.html å¡«å…¥ LIFF_ID");
    return;
  }
  try{
    await liff.init({ liffId: LIFF_ID });

    if (!liff.isInClient()){
      setStatus(false, "è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿï¼ˆåœ–æ–‡é¸å–® / LIFF é€£çµï¼‰");
      await Swal.fire("è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ", "è«‹é»é¸å®˜æ–¹å¸³è™Ÿçš„åœ–æ–‡é¸å–® / LIFF é€£çµé€²å…¥ã€‚", "warning");
      return;
    }
    const profile = await liff.getProfile();
    lineUid = profile.userId || "";
    setStatus(true, "å·²é€£ç·š âœ” è«‹å…ˆé–±è®€è¦å‰‡ä¸¦å‹¾é¸åŒæ„å¾Œé–‹å§‹é ç´„ã€‚");
  }catch(err){
    console.error(err);
    setStatus(false, "LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ LIFF ID / Endpoint URLã€‚");
    Swal.fire("LIFF åˆå§‹åŒ–å¤±æ•—", String(err?.message || err), "error");
  }
}

async function apiGet(url){
  const res = await fetch(url, { cache:"no-store" });
  return await res.json();
}
async function apiPostJson(payload){
  const res = await fetch(GAS_EXEC_URL, { method:"POST", body: JSON.stringify(payload) });
  return await res.json();
}

async function loadVaccines(){
  if (!GAS_EXEC_URL || GAS_EXEC_URL.includes("è«‹å¡«å…¥")) {
    setStatus(false, "è«‹å…ˆåœ¨ index.html å¡«å…¥ GAS_EXEC_URL");
    return;
  }
  const data = await apiGet(`${GAS_EXEC_URL}?action=vaccines`);
  if (!data.ok) {
    setStatus(false, data.msg || "è®€å–ç–«è‹—æ¸…å–®å¤±æ•—");
    return;
  }
  vaccines = data.items || [];

  const sel = document.getElementById("vaccineId");
  sel.innerHTML = `<option value="">è«‹é¸æ“‡ç–«è‹—</option>` + vaccines.map(v => {
    const label = `${v.name}ï¼ˆ$${fmtMoney(v.price)}/åŠ‘ï¼‰`;
    return `<option value="${encodeURIComponent(v.vaccineId)}">${label}</option>`;
  }).join("");

  sel.addEventListener("change", onVaccineChange);
  onVaccineChange();
}

function onVaccineChange(){
  const sel = document.getElementById("vaccineId");
  const vid = decodeURIComponent(sel.value || "");
  const box = document.getElementById("vaccineInfo");
  const text = document.getElementById("vaccineInfoText");
  const v = vaccines.find(x => x.vaccineId === vid);

  if (!v){
    box.style.display = "none";
    text.textContent = "";
    return;
  }
  box.style.display = "block";
  const note = v.note ? `å‚™è¨»ï¼š${v.note}` : "å‚™è¨»ï¼šâ€”";
  text.textContent = `åƒ¹æ ¼ï¼š$${fmtMoney(v.price)}/åŠ‘\n${note}\nï¼ˆæ‰€æœ‰ç–«è‹—æ–½æ‰“çš†éœ€å…ˆç”±é†«å¸«è©•ä¼°ï¼‰`;
}

/** âœ… å›ºå®šé¡¯ç¤ºã€Œä¸Šåˆ/ä¸‹åˆ/æ™šä¸Šã€åˆ†éš”ï¼›æ²’æœ‰æ™‚æ®µå°±é¡¯ç¤ºæœ¬æ™‚æ®µæœªé–‹æ”¾ */
function renderTimeGroups(groups, blockedMsg){
  const wrap = document.getElementById("timeGroups");
  wrap.innerHTML = "";

  const hiddenSelect = document.getElementById("time");
  hiddenSelect.innerHTML = `<option value="">è«‹é¸æ“‡æ™‚æ®µ</option>`;

  if (blockedMsg){
    wrap.innerHTML = `<div class="hint">${blockedMsg}</div>`;
    hiddenSelect.value = "";
    return;
  }

  const periods = ["ä¸Šåˆ","ä¸‹åˆ","æ™šä¸Š"];
  let total = 0;

  periods.forEach(p => {
    const times = (groups && groups[p]) ? groups[p] : [];
    total += times.length;

    const group = document.createElement("div");
    group.className = "group";

    const title = document.createElement("div");
    title.className = "group-title";
    title.textContent = p;
    group.appendChild(title);

    if (!times.length){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = "æœ¬æ™‚æ®µæœªé–‹æ”¾";
      group.appendChild(empty);
      wrap.appendChild(group);
      return;
    }

    const chips = document.createElement("div");
    chips.className = "chips";

    times.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t; // âœ… å€é–“å€¼
      opt.textContent = `${p} ${t}`;
      hiddenSelect.appendChild(opt);

      const chip = document.createElement("button");
      chip.type = "button";
      chip.className = "chip";
      chip.textContent = t; // âœ… é¡¯ç¤ºå€é–“
      chip.addEventListener("click", () => {
        wrap.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
        chip.classList.add("active");
        hiddenSelect.value = t;
      });
      chips.appendChild(chip);
    });

    group.appendChild(chips);
    wrap.appendChild(group);
  });

  if (total === 0){
    wrap.innerHTML = `<div class="hint">æ­¤æ—¥æœŸæœªé–‹æ”¾æ™‚æ®µï¼Œè«‹æ”¹é¸å…¶ä»–æ—¥æœŸæˆ–ç”±æ«ƒæª¯å”åŠ©ã€‚</div>`;
    hiddenSelect.value = "";
  }
}

async function loadTimesByDate(dateStr){
  if (!dateStr) return;
  const data = await apiGet(`${GAS_EXEC_URL}?action=times&date=${encodeURIComponent(dateStr)}`);
  if (!data.ok){
    renderTimeGroups({}, data.msg || "è®€å–æ™‚æ®µå¤±æ•—");
    return;
  }
  renderTimeGroups(data.groups || {}, data.blockedMsg || "");
}

async function refreshMyBookingUI(){
  const box = document.getElementById("myBox");
  const text = document.getElementById("myText");
  const btnCancel = document.getElementById("btnCancel");

  const me = await apiGet(`${GAS_EXEC_URL}?action=my&lineId=${encodeURIComponent(lineUid)}`);

  if (!me.ok){
    box.style.display = "block";
    text.textContent = me.msg || "æŸ¥è©¢å¤±æ•—";
    btnCancel.style.display = "none";
    return;
  }

  if (!me.hasBooking){
    box.style.display = "block";
    text.textContent = "ç›®å‰æ²’æœ‰æœ‰æ•ˆé ç´„ã€‚";
    btnCancel.style.display = "none";
    return;
  }

  const b = me.booking || {};
  text.textContent =
`å§“åï¼š${b.name || ""}
é›»è©±ï¼š${b.phone || ""}
ç–«è‹—ï¼š${b.vaccineName || ""}
æ—¥æœŸï¼š${b.date || ""}
æ™‚é–“ï¼š${b.time || ""}`;
  box.style.display = "block";
  btnCancel.style.display = "inline-block";
}

async function doCancel(){
  const sure = await Swal.fire({
    title: "ç¢ºèªå–æ¶ˆé ç´„ï¼Ÿ",
    text: "å–æ¶ˆå¾Œå°‡ç«‹å³é€šçŸ¥ä½ å·²å–æ¶ˆã€‚",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "ç¢ºèªå–æ¶ˆ",
    cancelButtonText: "å…ˆä¸è¦"
  });
  if (!sure.isConfirmed) return;

  const json = await apiPostJson({ action:"cancel", lineId: lineUid });

  if (!json.ok){
    await Swal.fire("å–æ¶ˆå¤±æ•—", json.msg || "å–æ¶ˆå¤±æ•—", "error");
    return;
  }

  // âœ… å‰ç«¯ LIFF ä¹Ÿé€ä¸€å‰‡ï¼ˆæœ€ç©©ï¼›å°±ç®—å¾Œç«¯ token æ²’è¨­ä¹Ÿæœ‰è¨Šæ¯ï¼‰
  try{
    const b = json.booking || {};
    const cancelMsg =
`âŒ å¾·æ˜Œå°å…’ç§‘è¨ºæ‰€ï½œå·²å–æ¶ˆé ç´„
å§“åï¼š${b.name || ""}
ç–«è‹—ï¼š${b.vaccineName || ""}
æ—¥æœŸï¼š${b.date || ""}
æ™‚é–“ï¼š${b.time || ""}`;
    await liff.sendMessages([{ type:"text", text: cancelMsg }]);
  }catch(e){}

  await Swal.fire("å·²å–æ¶ˆé ç´„", "å–æ¶ˆæˆåŠŸ", "success");
  await refreshMyBookingUI();
}

function getSelectedVaccineText(){
  const sel = document.getElementById("vaccineId");
  const opt = sel.selectedOptions?.[0];
  return opt ? opt.textContent : "";
}

async function onSubmit(e){
  e.preventDefault();
  const form = document.getElementById("form");
  if (!form.reportValidity()) return;

  const dateStr = document.getElementById("date").value;
  const today = new Date();
  const minD = ymd(dateAddDays(today, 7));
  const maxD = ymd(dateAddDays(today, 28));
  if (dateStr < minD || dateStr > maxD){
    await Swal.fire("æ—¥æœŸä¸åœ¨å¯é ç´„ç¯„åœ", `è«‹é¸æ“‡ ${minD} ï½ ${maxD}`, "warning");
    return;
  }

  const slot = document.getElementById("time").value;
  if (!slot){
    await Swal.fire("è«‹é¸æ“‡é ç´„æ™‚æ®µ", "è«‹å…ˆé¸æ—¥æœŸï¼Œå†é»é¸ä¸€å€‹å¯é ç´„çš„æ™‚æ®µã€‚", "warning");
    return;
  }

  const payload = {
    action: "book",
    lineId: lineUid,
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    birthday: document.getElementById("birthday").value,
    idCard: document.getElementById("idCard").value.trim(),
    vaccineId: decodeURIComponent(document.getElementById("vaccineId").value || ""),
    date: dateStr,
    time: slot // âœ… å€é–“å€¼
  };

  const vaccineText = getSelectedVaccineText();

  const confirm = await Swal.fire({
    title: "ç¢ºèªé ç´„å…§å®¹",
    html: `
      <div style="text-align:left;line-height:1.8">
        <div><b>å§“åï¼š</b>${payload.name}</div>
        <div><b>é›»è©±ï¼š</b>${payload.phone}</div>
        <div><b>ç–«è‹—ï¼š</b>${vaccineText}</div>
        <div><b>æ—¥æœŸï¼š</b>${mdFromYmd(payload.date)}</div>
        <div><b>æ™‚é–“ï¼š</b>${slotHm(payload.time)}</div>
      </div>`,
    icon: "question",
    showCancelButton: true,
    confirmButtonText: "ç¢ºèªé€å‡º",
    cancelButtonText: "è¿”å›ä¿®æ”¹"
  });
  if (!confirm.isConfirmed) return;

  document.getElementById("btnSubmit").disabled = true;

  try{
    const json = await apiPostJson(payload);
    if (!json.ok){
      await Swal.fire("é€å‡ºå¤±æ•—", json.msg || "è«‹ç¨å¾Œå†è©¦", "error");
      return;
    }

    // âœ… é ç´„æˆåŠŸï¼šå‰ç«¯ LIFF ç«‹å³é€ï¼ˆå¾Œç«¯ token æœ‰è¨­ä¹Ÿæœƒå† push ä¸€æ¬¡ï¼‰
    try{
      const bookingMsg =
`âœ… å¾·æ˜Œå°å…’ç§‘è¨ºæ‰€ï½œé ç´„æˆåŠŸ
å§“åï¼š${payload.name}
ç–«è‹—ï¼š${vaccineText}
æ—¥æœŸï¼š${mdFromYmd(payload.date)}
æ™‚é–“ï¼š${slotHm(payload.time)}

æé†’ï¼šè«‹æ”œå¸¶å¥ä¿å¡ã€ç¾é‡‘ï¼›åœ‹å°ä»¥ä¸‹å­©ç«¥è«‹æ”œå¸¶å…’ç«¥å¥åº·æ‰‹å†Šã€‚`;
      await liff.sendMessages([{ type:"text", text: bookingMsg }]);
    }catch(e){}

    await Swal.fire("é ç´„æˆåŠŸ", "å·²å®Œæˆé ç´„ï¼å‰ä¸€å¤©æ™šä¸Š 19:00 æœƒå†æ¨æ’­æé†’ã€‚", "success");
    await refreshMyBookingUI();
  } finally {
    document.getElementById("btnSubmit").disabled = false;
  }
}

/** è¦å‰‡åŒæ„ gating */
const agreeEl = document.getElementById("agree");
const btnGoBooking = document.getElementById("btnGoBooking");
agreeEl.addEventListener("change", () => { btnGoBooking.disabled = !agreeEl.checked; });
btnGoBooking.addEventListener("click", () => { if (agreeEl.checked) showPage("pageBooking"); });

document.getElementById("btnHelp").addEventListener("click", async () => {
  await Swal.fire("å¸¸è¦‹å•é¡Œ",
    "1) è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ\n2) è‹¥çœ‹ä¸åˆ°æ™‚æ®µï¼šè«‹å…ˆé¸æ—¥æœŸï¼ˆæˆ–è©²æ—¥æœªé–‹æ”¾ï¼‰\n3) é€±äº”å…¨æ—¥ä¸é–‹æ”¾ã€é€±æ—¥æ™šä¸Šä¸é–‹æ”¾\n4) ä¼‘å‡æ—¥/åœ‹å®šå‡æ—¥å¯ç”± TimeRules è¨­å®š",
    "info"
  );
});

document.getElementById("form").addEventListener("submit", onSubmit);
document.getElementById("btnMy").addEventListener("click", refreshMyBookingUI);
document.getElementById("btnCancel").addEventListener("click", doCancel);

document.getElementById("date").addEventListener("change", async (e) => {
  document.getElementById("time").value = "";
  document.getElementById("timeGroups").querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
  await loadTimesByDate(e.target.value);
});

(async function main(){
  enforceDateWindow();
  await initLIFF();
  if (!lineUid) return;
  await loadVaccines();
  await refreshMyBookingUI();
})();
</script>
</body>
</html>

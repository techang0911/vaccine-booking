<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ç–«è‹—é ç´„</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    :root{--bg:#f6fbff;--card:#fff;--main:#34b7a7;--main2:#2aa295;--muted:#6b7280;--border:#e5e7eb;}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;background:linear-gradient(180deg,var(--bg),#fff);padding:18px;}
    .wrap{max-width:520px;margin:0 auto;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:0 10px 25px rgba(0,0,0,.08);overflow:hidden;}
    .header{padding:18px;background:linear-gradient(135deg,#2c7be5,var(--main));color:#fff;}
    .header h1{margin:0;font-size:18px;}
    .header p{margin:6px 0 0;opacity:.9;font-size:12px;}
    .badge{display:inline-block;background:rgba(255,255,255,.2);padding:4px 10px;border-radius:999px;font-size:12px;margin-top:10px;}
    .content{padding:18px;}
    label{display:block;margin:12px 0 6px;font-size:13px;color:#374151;}
    input,select{width:100%;box-sizing:border-box;padding:11px 12px;border:1px solid var(--border);border-radius:12px;font-size:15px;outline:none;background:#fff;}
    .row{display:flex;gap:10px;}
    .row>div{flex:1;}
    .btn{width:100%;padding:12px 14px;border:none;border-radius:12px;background:var(--main);color:#fff;font-weight:700;font-size:15px;cursor:pointer;margin-top:16px;}
    .btn:hover{background:var(--main2);}
    .mini{margin-top:12px;font-size:13px;color:#111827;background:#f9fafb;border:1px solid var(--border);padding:12px;border-radius:12px;white-space:pre-wrap;}
    .muted{color:var(--muted);font-size:12px;margin-top:6px;}
    .okdot{display:inline-block;width:8px;height:8px;border-radius:99px;background:#22c55e;margin-right:6px;}
    .baddot{display:inline-block;width:8px;height:8px;border-radius:99px;background:#ef4444;margin-right:6px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <h1>ğŸ’‰ ç–«è‹—é ç´„ç³»çµ±</h1>
        <p>è«‹å…ˆåŒæ„è²æ˜ï¼Œå†å¡«å¯«è³‡æ–™é€å‡º</p>
        <div class="badge" id="statusBadge"><span class="baddot"></span>åˆå§‹åŒ–ä¸­â€¦</div>
      </div>

      <div class="content">
        <div id="pageRules">
          <div class="mini">ãƒ»æ¯æ™‚æ®µé™é¡ï¼ˆç³»çµ±åˆ¤æ–·ï¼‰
ãƒ»åŒä¸€å€‹ LINE å¸³è™Ÿåƒ…èƒ½é ç´„ä¸€æ¬¡
ãƒ»âš ï¸ æ‰€æœ‰ç–«è‹—çš†éœ€å…ˆç¶“é†«å¸«è©•ä¼°æ˜¯å¦é©åˆæ–½æ‰“</div>

          <label style="margin-top:14px;">
            <input type="checkbox" id="agree" style="width:auto;transform:scale(1.1);margin-right:8px;">
            æˆ‘å·²é–±è®€ä¸¦åŒæ„ä¸Šè¿°è¦å‰‡
          </label>

          <button class="btn" id="btnNext">åŒæ„ä¸¦ç¹¼çºŒ</button>
          <div class="muted">æ­£å¼ä½¿ç”¨è«‹å¾ LINE å…§çš„ LIFF å…¥å£é–‹å•Ÿã€‚</div>
        </div>

        <div id="pageForm" style="display:none;">
          <form id="form">
            <label>ç–«è‹—é …ç›®ï¼ˆåç¨±ï¼‹åƒ¹æ ¼ï¼‰</label>
            <select name="vaccineId" id="vaccineSelect" required>
              <option value="">è¼‰å…¥ä¸­â€¦</option>
            </select>

            <div id="vaccineInfo" class="mini" style="display:none;"></div>

            <div class="row">
              <div>
                <label>é ç´„æ—¥æœŸ</label>
                <input type="date" name="date" id="dateInput" required>
                <div class="muted">è‹¥è©²æ—¥æœ‰è¨­å®šç‰¹æ®Šå‡æœŸï¼ˆTimeRulesï¼‰ï¼Œæ™‚æ®µæœƒè‡ªå‹•æ›´æ–°ã€‚</div>
              </div>
              <div>
                <label>é ç´„æ™‚æ®µï¼ˆä¸Šåˆ / ä¸‹åˆ / æ™šä¸Šï¼‰</label>
                <select name="time" id="timeSelect" required></select>
              </div>
            </div>

            <label>å§“å</label>
            <input name="name" placeholder="è«‹è¼¸å…¥å§“å" required>

            <label>é›»è©±</label>
            <input name="phone" placeholder="09xx-xxx-xxx" required>

            <label>èº«åˆ†è­‰</label>
            <input name="idCard" placeholder="A123456789" required>

            <label>å‡ºç”Ÿæ—¥æœŸ</label>
            <input type="date" name="birthday" required>

            <button class="btn" type="submit">é€å‡ºé ç´„</button>
          </form>
        </div>
      </div>
    </div>
  </div>

<script>
  // âœ… åªæ”¹é€™å…©å€‹
  const LIFF_ID = "2008829528-z2IIrBwj";
  const GAS_EXEC_URL = "https://script.google.com/macros/s/AKfycbxtA1h2KPLTuhAc6eQX4WD7g0RHwL-YYy669ZxLlYfUBdqdovmxb4S4IMsKViWzeCw/exec";

  const statusBadge = document.getElementById("statusBadge");
  const pageRules = document.getElementById("pageRules");
  const pageForm  = document.getElementById("pageForm");
  const btnNext   = document.getElementById("btnNext");

  const vaccineSelect = document.getElementById("vaccineSelect");
  const vaccineInfo = document.getElementById("vaccineInfo");

  const timeSelect = document.getElementById("timeSelect");
  const dateInput = document.getElementById("dateInput");

  let lineUid = "";
  let vaccineMap = new Map(); // vaccineId -> {name, price, note}

  const DEFAULT_TIME_GROUPS = {
    "ä¸Šåˆ": ["09:00â€“09:30", "09:30â€“10:00", "10:00â€“10:30"],
    "ä¸‹åˆ": ["15:30â€“16:00", "16:30â€“17:00"],
    "æ™šä¸Š": ["19:30â€“20:00", "20:00â€“20:30"],
  };

  function setStatus(ok, text){
    statusBadge.innerHTML = (ok ? '<span class="okdot"></span>' : '<span class="baddot"></span>') + text;
  }
  function money(n){
    try { return "$" + Number(n).toLocaleString("zh-TW"); } catch { return "$" + n; }
  }

  // ===== Vaccines =====
  async function loadVaccines(){
    const url = GAS_EXEC_URL + "?action=vaccines";
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    const json = await res.json();

    if (!json.ok) throw new Error(json.msg || "ç–«è‹—æ¸…å–®è®€å–å¤±æ•—");

    vaccineMap.clear();
    vaccineSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

    for (const it of (json.items || [])) {
      vaccineMap.set(it.vaccineId, it);
      const opt = document.createElement("option");
      opt.value = it.vaccineId;
      opt.textContent = `${it.name}ï½œ${money(it.price)}/åŠ‘`;
      vaccineSelect.appendChild(opt);
    }
  }

  function renderVaccineInfo(){
    const id = vaccineSelect.value;
    if (!id || !vaccineMap.has(id)) {
      vaccineInfo.style.display = "none";
      vaccineInfo.textContent = "";
      return;
    }
    const v = vaccineMap.get(id);
    const noteLine = v.note ? `ğŸ“Œ å‚™è¨»ï¼š${v.note}\n` : "";
    vaccineInfo.textContent =
      `ğŸ’‰ ç–«è‹—ï¼š${v.name}\n` +
      `ğŸ’° åƒ¹æ ¼ï¼š${money(v.price)}/åŠ‘\n` +
      noteLine +
      `âš ï¸ æœ¬ç–«è‹—éœ€å…ˆç¶“é†«å¸«è©•ä¼°æ˜¯å¦é©åˆæ–½æ‰“`;
    vaccineInfo.style.display = "block";
  }
  vaccineSelect.addEventListener("change", renderVaccineInfo);

  // ===== Times =====
  function renderTimeOptions(groups) {
    timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';

    for (const [label, times] of Object.entries(groups)) {
      if (!times || times.length === 0) continue;

      const og = document.createElement("optgroup");
      og.label = label;

      for (const t of times) {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        og.appendChild(opt);
      }
      timeSelect.appendChild(og);
    }

    // æ•´å¤©ç„¡æ™‚æ®µ
    if (timeSelect.querySelectorAll("option").length <= 1) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "ç•¶æ—¥ç„¡å¯é ç´„æ™‚æ®µ";
      opt.disabled = true;
      timeSelect.appendChild(opt);
    }
  }

  async function refreshTimesByDate(dateStr) {
    if (!dateStr) {
      renderTimeOptions(DEFAULT_TIME_GROUPS);
      return;
    }

    const url = GAS_EXEC_URL + "?action=times&date=" + encodeURIComponent(dateStr);
    const res = await fetch(url, { method: "GET", cache: "no-store" });
    const json = await res.json();

    if (json.ok && json.useDefault === false) {
      renderTimeOptions(json.groups || {});
    } else {
      renderTimeOptions(DEFAULT_TIME_GROUPS);
    }
  }

  // ===== LIFF init =====
  async function init(){
    try{
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isInClient()){
        setStatus(false, "è«‹å¾ LIFF å…¥å£é–‹å•Ÿ");
        Swal.fire("è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ", "è«‹é»é¸å®˜æ–¹å¸³è™Ÿçš„åœ–æ–‡é¸å–® / LIFF é€£çµé€²å…¥ã€‚", "warning");
        return;
      }
      if (!liff.isLoggedIn()){
        setStatus(false, "å°å‘ç™»å…¥ä¸­â€¦");
        liff.login();
        return;
      }

      const p = await liff.getProfile();
      lineUid = p.userId;
      setStatus(true, "å·²é€£ç·š LINE");

      // å…ˆæ¸²æŸ“é è¨­æ™‚æ®µ
      renderTimeOptions(DEFAULT_TIME_GROUPS);

      // è¼‰å…¥ç–«è‹—æ¸…å–®
      await loadVaccines();
      vaccineSelect.value = "";
      renderVaccineInfo();

      // æ—¥æœŸè®Šæ›´æ™‚ï¼Œä¾ TimeRules æ›´æ–°æ™‚æ®µ
      dateInput.addEventListener("change", () => {
        refreshTimesByDate(dateInput.value);
      });

    }catch(err){
      setStatus(false, "åˆå§‹åŒ–å¤±æ•—");
      Swal.fire("åˆå§‹åŒ–å¤±æ•—", String(err?.message || err), "error");
    }
  }
  window.addEventListener("load", init);

  // ===== Page flow =====
  btnNext.addEventListener("click", () => {
    if (!document.getElementById("agree").checked){
      Swal.fire("è«‹å…ˆå‹¾é¸åŒæ„", "", "info");
      return;
    }
    pageRules.style.display = "none";
    pageForm.style.display = "block";
  });

  // ===== Submit =====
  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!liff.isInClient() || !lineUid){
      Swal.fire("è«‹å¾ LINE å®˜æ–¹å…¥å£é–‹å•Ÿ", "ç›®å‰ç„¡æ³•å–å¾— LINE ä½¿ç”¨è€…è³‡è¨Š", "warning");
      return;
    }

    const data = {};
    new FormData(e.target).forEach((v,k)=> data[k]=v);
    data.lineId = lineUid;

    try{
      Swal.fire({ title:"é€å‡ºä¸­â€¦", allowOutsideClick:false, didOpen:()=>Swal.showLoading() });

      // âœ… ä¸å¸¶ headersï¼Œé¿å… OPTIONS preflightï¼ˆLoad failedï¼‰
      const res = await fetch(GAS_EXEC_URL, {
        method: "POST",
        body: JSON.stringify(data),
        redirect: "follow",
        cache: "no-store",
      });

      const json = await res.json();

      if (json.ok){
        await Swal.fire("é ç´„æˆåŠŸ", "è³‡æ–™å·²é€å‡º", "success");
        liff.closeWindow();
      } else {
        Swal.fire("é€å‡ºå¤±æ•—", json.msg || json.message || "æœªçŸ¥éŒ¯èª¤", "error");
      }
    }catch(err){
      Swal.fire("é€å‡ºå¤±æ•—", String(err?.message || err), "error");
    }
  });
</script>
</body>
</html>
